/* ===== 基本 ===== */
*{box-sizing:border-box}
html{height:100%;-webkit-text-size-adjust:100%}
body{
  margin:0;background:#000;color:#eee;
  font-family:"dnp-shuei-gothic-kin-std","Yu Gothic","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
  -webkit-font-smoothing:antialiased;
}

/* ページ全体はスクロール禁止（セクションが覗けないように） */
html, body { height:100%; overflow:hidden }

/* vh補正 */
:root{ --vh: 1vh; }
@supports (height: 100svh){ .screen{ min-height:100svh } }
@supports (height: 100dvh) and not (height: 100svh){ .screen{ min-height:100dvh } }
@supports not (height: 100svh) and not (height: 100dvh){ .screen{ min-height:calc(var(--vh)*100) } }

/* 画面：中央寄せ */
.screen{
  display:grid; place-items:center;
  width:100%; padding:0 6%; position:relative; text-align:center;
}
.screen.active{ display:grid }
.hidden{ display:none }
.center{ max-width:760px; width:100% }
.spaced{ letter-spacing:.22em; line-height:1.9 }
.percent{ margin-top:.6rem; color:#777 }

/* 見出し */
.kaiki{
  color:#8b0000; text-shadow:0 0 12px rgba(139,0,0,.35);
  font-size:clamp(22px,8.2vw,40px);
  letter-spacing:.08em; white-space:normal; word-break:keep-all;
}
.kaiki-sub{ margin:.2rem 0 10px; color:#8b0000; letter-spacing:.12em; font-size:1rem }
.who-line{ color:#aaa; letter-spacing:.18em; margin:.2rem 0 .8rem; font-size:clamp(12px,3.6vw,14px) }

/* “発祥ストーリー”の折返し防止 */
.no-wrap{ white-space:nowrap }
@media (max-width:430px){
  .no-wrap{ letter-spacing:.14em; font-size:.86rem }
}

/* 全体薄ノイズ */
#noise{ position:fixed; inset:0; background:rgba(255,255,255,.03); opacity:.06;
  pointer-events:none; z-index:1; transition:opacity .25s }
#noise.strong{ opacity:.35 }

/* 背景ノイズ（動画 or gif） */
.bg-noise{ position:absolute; inset:0; z-index:0; overflow:hidden; }
.bgv{
  position:absolute; inset:-10% -10% -10% -10%; width:120%; height:120%;
  object-fit:cover; filter: contrast(1.08) saturate(0.9) brightness(0.82);
  opacity:.5; pointer-events:none;
}
/* 受付/発祥は青系にシフト */
.bg-noise[data-type="entry"] .bgv,
.bg-noise[data-type="story"] .bgv{
  filter: hue-rotate(210deg) contrast(1.08) saturate(0.9) brightness(0.82);
  opacity:.56;
}
/* カルテはニュートラル */
.bg-noise[data-type="records"] .bgv{
  filter: contrast(1.08) saturate(1.0) brightness(0.86);
  opacity:.44;
}
.bg-gif{ position:absolute; inset:0; background-size:cover; background-repeat:repeat; opacity:0; pointer-events:none; }
.no-video .bg-gif{ opacity:.36 } /* 動画不可の時はgifを出す */

/* FXレイヤ */
#fx{ position:fixed; inset:0; pointer-events:none; z-index:12; mix-blend-mode:overlay }
.fx-grain,.fx-scratches,.fx-rollbar{ position:absolute; inset:0 }
.fx-grain{ background-image:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,.06), rgba(0,0,0,0) 38%),
    radial-gradient(circle at 70% 60%, rgba(255,255,255,.05), rgba(0,0,0,0) 42%),
    repeating-conic-gradient(from 0deg, rgba(255,255,255,.08) 0 .5deg, rgba(0,0,0,0) .5deg 1deg);
  opacity:.26; animation:fxGrainShift 1.2s steps(2) infinite }
@keyframes fxGrainShift{0%{transform:translate(0,0)}50%{transform:translate(-1px,1px)}100%{transform:translate(0,0)}}
.fx-scratches{ background:
    repeating-linear-gradient(to right, rgba(255,255,255,.12) 0 1px, rgba(0,0,0,0) 1px 4px),
    repeating-linear-gradient(to right, rgba(255,255,255,.05) 0 2px, rgba(0,0,0,0) 2px 7px);
  opacity:.16; animation:fxScratchDrift 12s linear infinite }
@keyframes fxScratchDrift{0%{transform:translateX(0)}100%{transform:translateX(-60px)}}
.fx-rollbar{ background:linear-gradient(to bottom,rgba(255,255,255,0),rgba(255,255,255,.24) 50%,rgba(255,255,255,0)); opacity:0; transform:translateY(-120%) }
.fx-rollbar.run{ animation:fxRoll 1.8s linear 1 }
@keyframes fxRoll{0%{opacity:0;transform:translateY(-120%)}10%{opacity:.48}90%{opacity:.48}100%{opacity:0;transform:translateY(120%)}}

/* RGBずれ・ティア・グローバルブレイク */
.rgb-split *{ text-shadow:1px 0 rgba(255,0,0,.35),-1px 0 rgba(0,0,255,.35); filter:contrast(1.05) saturate(1.05) }
.vsync-drift{ animation:vsyncDrift 6s ease-in-out infinite alternate }
@keyframes vsyncDrift{0%{transform:translateY(0)}100%{transform:translateY(1.6px)}}
.screen-tear::after{
  content:""; position:absolute; left:0; right:0; height:14px; top:40%;
  background:linear-gradient(to right,rgba(255,255,255,.14),rgba(0,0,0,0)); mix-blend-mode:screen; opacity:0; transform:translateX(-8px);
  animation:screenTear .22s steps(1) 1
}
@keyframes screenTear{0%{opacity:0}20%{opacity:.42;transform:translateX(8px)}100%{opacity:0;transform:translateX(0)}}
.global-break{
  animation:globalBreakA .18s steps(1) 1, globalBreakB .28s ease 1;
  filter:invert(.06) contrast(1.2) saturate(1.15) hue-rotate(6deg)
}
@keyframes globalBreakA{0%{transform:none}50%{transform:skewX(3deg) translateX(2px)}100%{transform:none}}
@keyframes globalBreakB{0%{box-shadow:inset 0 0 0 rgba(255,0,0,0)}50%{box-shadow:inset 0 0 48px rgba(255,255,255,.06)}100%{box-shadow:inset 0 0 0 rgba(255,0,0,0)}}

/* “ガガガ” */
@keyframes jolt{0%{transform:none;filter:none}15%{transform:skewX(2deg) translateX(1px)}
30%{transform:skewX(-2deg) translateX(-1px);filter:contrast(1.08)}45%{transform:skewY(1deg)}
60%{transform:skewY(-1deg)}75%{transform:translateX(1px)}100%{transform:none;filter:none}}
.jolt{ animation:jolt .22s steps(1) 1 }

/* レトロUI */
.browser.retro{
  position:relative; z-index:2; width:100%; max-width:900px; background:#c0c0c0; border:2px solid #000;
  box-shadow:0 0 0 1px #fff inset,0 0 0 2px #808080 inset,0 0 0 3px #fff inset; overflow:hidden
}
.retro-titlebar{
  display:flex; align-items:center; justify-content:space-between;
  background:#000080; color:#fff; padding:6px 8px; letter-spacing:.22em; font-size:.9rem; user-select:none
}
.retro-title{ font-weight:bold }
.retro-controls{ display:flex; gap:6px }
.retro-controls .ctrl{ min-width:22px; text-align:center; padding:2px 4px; background:#c0c0c0; color:#000; border:2px solid #000;
  box-shadow:0 0 0 1px #fff inset,0 0 0 2px #808080 inset,0 0 0 3px #fff inset }
.retro-controls .ctrl:active{ box-shadow:0 0 0 1px #808080 inset,0 0 0 2px #fff inset,0 0 0 3px #808080 inset }
.retro-controls .ctrl.close{ color:#800000 }
.retro-pane{ padding:12px; text-align:left; color:#000; background:#c0c0c0; position:relative }

/* CRT質感 */
.browser.retro.crt, .records.crt{ position:relative; isolation:isolate; overflow:hidden; filter:contrast(1.04) saturate(0.96) }
.browser.retro.crt::before,.records.crt::before{
  content:""; position:absolute; inset:-4%; z-index:8; pointer-events:none;
  background:radial-gradient(ellipse at center,rgba(255,255,255,.025) 0%,rgba(255,255,255,0) 60%,rgba(0,0,0,.42) 100%);
  border-radius:2.6%/1.9%; transform:perspective(1000px) scale(1.018)
}
.browser.retro.crt::after,.records.crt::after{
  content:""; position:absolute; inset:0; z-index:8; pointer-events:none;
  background:repeating-linear-gradient(to bottom,rgba(255,255,255,.06),rgba(255,255,255,.06) 1px,transparent 1px,transparent 3px);
  mix-blend-mode:overlay; opacity:.62; animation:crtFlicker 4.5s steps(1) infinite
}
@keyframes crtFlicker{0%,98%{opacity:.62}99%{opacity:.7}100%{opacity:.62}}

/* ウィンドウ出現アニメ（下からスッ…） */
.appear{ transform:translateY(16px); opacity:0; animation:winIn .42s ease forwards }
@keyframes winIn{ to{ transform:none; opacity:1 } }

/* 発祥テキスト（フェードイン／行間詰め） */
.story-fade{ opacity:0; transition:opacity .5s ease }
.story-fade.show{ opacity:1 }
#story-text{ line-height:1.78; font-size:clamp(14px,3.9vw,18px); letter-spacing:.005em }

/* スクロールボックス：明示高さ（JSでpx再指定して安定化） */
.scrollbox{
  overflow-y:auto; overflow-x:hidden; padding:10px; background:#fff; color:#111; border:2px solid #000;
  box-shadow:0 0 0 1px #fff inset,0 0 0 2px #808080 inset,0 0 0 3px #fff inset;
  -webkit-overflow-scrolling:touch;
}
/* デフォ代替（JS前の暫定値） */
#story-scroll{ height:56svh; max-height:62svh }
#chant-scroll{ height:26svh; max-height:30svh }

/* “たすけて” */
.help-chant{ color:#8b0000; letter-spacing:0; font-weight:600; opacity:0; transition:opacity .25s ease }
.help-chant.show{ opacity:1 }

/* ボタン */
.btn{
  background:#c0c0c0; color:#000; border:2px solid #000;
  box-shadow:0 0 0 1px #fff inset,0 0 0 2px #808080 inset,0 0 0 3px #fff inset;
  border-radius:2px; margin-top:16px; padding:.55rem 1rem; cursor:pointer; transition:transform .1s,color .2s,box-shadow .12s
}
.btn:hover{ color:#8b0000 }
.btn:active{ box-shadow:0 0 0 1px #808080 inset,0 0 0 2px #fff inset,0 0 0 3px #808080 inset; transform:translateY(1px) scale(.99) }

/* 受付入力を少し大きめに */
.entry-form{ display:flex; gap:10px; align-items:center; margin:.6rem 0 .4rem }
#nick-input{
  width:100%; max-width:420px; padding:.72rem .8rem; background:#fff; color:#111; border:2px solid #000;
  box-shadow:0 0 0 1px #fff inset,0 0 0 2px #808080 inset,0 0 0 3px #fff inset; font-size:1rem;
}
#nick-input:focus{ outline:none; border-color:#8b0000 }
.entry-note{ color:#333; font-size:.85rem; margin:.2rem 0 0 }

/* 注意書きは赤 */
.warning{ color:#8b0000 }

/* カルテ（このブロック自体をスクロール可に） */
.records{ position:relative; z-index:2; width:100%; max-width:900px; text-align:left;
  max-height:78svh; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-right:.4rem; }
.records-title{ text-align:center; color:#8b0000; letter-spacing:.12em }
.card{ background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:8px; padding:12px; margin:12px 0 }
.karte{ width:100%; border-collapse:collapse; table-layout:fixed }
.karte th,.karte td{ padding:8px; border-bottom:1px dashed rgba(255,255,255,.08); vertical-align:top; word-break:break-word }
.karte th{ white-space:nowrap; width:30% }
.card.updated{ animation:updateBlink 1.2s ease 1 }
@keyframes updateBlink{0%{box-shadow:0 0 0 rgba(139,0,0,0)}20%{box-shadow:0 0 24px rgba(139,0,0,.45)}100%{box-shadow:0 0 0 rgba(139,0,0,0)}}
.badge-update{ display:inline-block; margin-left:.4em; padding:.1em .4em; background:#8b0000; color:#fff; font-size:.75em; border-radius:3px }

/* モーダル */
#modal{ position:fixed; inset:0; background:rgba(0,0,0,.86); z-index:9999; display:flex; justify-content:center; align-items:center; padding:20px; text-align:left; opacity:0; pointer-events:none; transition:opacity .22s }
#modal.open{ opacity:1; pointer-events:auto }
.modal-inner{ width:92%; max-width:680px; background:#0b0b0b; border:1px solid rgba(255,255,255,.08); border-radius:8px; padding:16px; transform:scale(.96) translateY(8px); transition:transform .22s,box-shadow .22s; box-shadow:0 18px 50px rgba(0,0,0,.55) }
#modal.open .modal-inner{ transform:scale(1) translateY(0); box-shadow:0 22px 60px rgba(0,0,0,.65) }
.modal-title{ margin:0 0 10px; color:#8b0000 }
.modal-body{ line-height:1.9 }
.modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }

/* モザイク等 */
.mosaic{ position:relative; display:inline-block; color:transparent; padding:0 .25em; border-radius:2px; outline:1px solid rgba(255,255,255,.12) }
.mosaic::after{
  content:""; position:absolute; inset:0; border-radius:2px;
  background:repeating-linear-gradient(135deg,rgba(20,20,20,1) 0 6px,rgba(0,0,0,.78) 6px 12px),
             linear-gradient(to bottom,rgba(255,255,255,.05),rgba(0,0,0,.0));
  opacity:.96; animation:mosaicPulse 3s ease-in-out infinite
}
@keyframes mosaicPulse{0%,100%{opacity:.96}50%{opacity:.86}}
.blacked{ background:#000; color:transparent; border-radius:2px; padding:0 6px; display:inline-block }
.marker{ background:linear-gradient(90deg,rgba(0,0,0,.96),rgba(0,0,0,.88)); color:transparent; padding:0 6px; border-radius:2px }

/* 文字化けフラッシュ */
.corrupt-flash{ animation:corruptFlash .18s steps(1) 1 }
@keyframes corruptFlash{0%{filter:none}50%{filter:contrast(1.15) saturate(1.1)}100%{filter:none}}

/* エラー揺れ */
@keyframes microShake{0%{transform:translateX(0)}25%{transform:translateX(1px)}50%{transform:translateX(-1px)}75%{transform:translateX(1px)}100%{transform:translateX(0)}}
.entry-error{ animation:microShake .18s linear 1 }

/* 発祥レイアウト */
.stack{ display:flex; flex-direction:column; gap:12px }
.win-main{ z-index:2 }
.win-mini{ z-index:3; width:min(480px,100%); margin-left:auto }
.win-mini.hidden{ display:none }

/* スマホ微調整 */
@media (max-width:430px){
  .retro-titlebar{ font-size:.86rem; letter-spacing:.18em }
}
